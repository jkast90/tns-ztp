# Development Dockerfile with hot reload

# ===========================================
# Backend development stage with Air
# ===========================================
FROM golang:1.23-alpine AS backend-dev

WORKDIR /app

# Install build dependencies and Air for hot reload
RUN apk add --no-cache gcc musl-dev dnsmasq && \
    go install github.com/air-verse/air@v1.61.0

# Create directories
RUN mkdir -p /data /tftp /backups /dnsmasq /configs/templates /var/lib/misc

# Copy go mod files first for caching
COPY backend/go.mod backend/go.sum ./
RUN go mod download

# Air config for hot reload
COPY <<EOF /app/.air.toml
root = "."
tmp_dir = "tmp"

[build]
  cmd = "go build -o ./tmp/main ."
  bin = "./tmp/main"
  delay = 1000
  exclude_dir = ["tmp", "vendor"]
  include_ext = ["go", "tpl", "tmpl", "html"]
  kill_delay = "0s"
  send_interrupt = false
  stop_on_error = true

[log]
  time = false

[color]
  main = "magenta"
  watcher = "cyan"
  build = "yellow"
  runner = "green"

[misc]
  clean_on_exit = true
EOF

# Entrypoint script that starts both dnsmasq and Air
COPY <<'EOF' /entrypoint-dev.sh
#!/bin/sh
set -e

# Create initial dnsmasq config if it doesn't exist
if [ ! -f "$DNSMASQ_CONFIG" ]; then
    mkdir -p "$(dirname "$DNSMASQ_CONFIG")"
    cat > "$DNSMASQ_CONFIG" <<DNSMASQ
interface=eth0
bind-interfaces
dhcp-range=172.30.0.100,172.30.0.200,255.255.255.0,12h
dhcp-option=3,172.30.0.1
enable-tftp
tftp-root=/tftp
dhcp-leasefile=/var/lib/misc/dnsmasq.leases
log-dhcp
log-facility=-
DNSMASQ
fi

# Start dnsmasq in background
dnsmasq -C "$DNSMASQ_CONFIG" --keep-in-foreground &

# Start Air for Go hot reload
exec air
EOF
RUN chmod +x /entrypoint-dev.sh

EXPOSE 8080
EXPOSE 67/udp
EXPOSE 69/udp

CMD ["/entrypoint-dev.sh"]


# ===========================================
# Frontend development stage with Vite
# ===========================================
FROM node:20-alpine AS frontend-dev

WORKDIR /app

# Copy package files
COPY frontend/package*.json ./

# Install dependencies
RUN npm install

# Create symlink script to run on start (symlinks don't persist in volumes)
COPY <<'EOF' /entrypoint-frontend.sh
#!/bin/sh
set -e

# Create/update core symlink
rm -rf /app/src/core
ln -sf /shared/core /app/src/core

# Start Vite dev server
exec npm run dev -- --host 0.0.0.0
EOF
RUN chmod +x /entrypoint-frontend.sh

EXPOSE 5173

CMD ["/entrypoint-frontend.sh"]
